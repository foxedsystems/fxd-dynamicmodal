!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).FxdDynamicModal={})}(this,function(t){"use strict";function e(t,e,o={}){t&&t.dispatchEvent(new CustomEvent(e,{detail:o,bubbles:!0}))}function o(t,e={}){const o=function(t={}){const e=new URLSearchParams;return Object.entries(t).forEach(([t,o])=>{null!=o&&(Array.isArray(o)?o.forEach(o=>{null!=o&&e.append(t,String(o))}):e.set(t,String(o)))}),e}(e),n=o.toString();return n?t+(t.includes("?")?"&":"?")+n:t}function n(t,e,o=null){if(!t)return;if(t.innerHTML="","undefined"!=typeof Node&&e instanceof Node){const o=e.cloneNode(!0);return void t.appendChild(o)}const n=null==e?"":String(e);t.innerHTML="function"==typeof o?o(n):n}function s(t,e){const o=function(t){if(!t||"md"===t)return"";const e=String(t).trim();return e?e.startsWith("modal-")?e:e.startsWith("fullscreen")||["sm","lg","xl","xxl"].includes(e)?`modal-${e}`:e:""}(e.size);var s,i;t.dialog.className="modal-dialog modal-dialog-centered",o&&t.dialog.classList.add(o),s=t.dialog,i=e.extraModalClass,s&&i&&i.split(" ").forEach(t=>{t&&s.classList.add(t)}),t.title.textContent=e.title??"",t.footer.style.display=e.showFooter?"flex":"none",t.closeBtn.style.display=e.showCloseBtn?"inline-block":"none",e.footerHtml&&n(t.footer,e.footerHtml,e.sanitize)}class i{constructor(t={}){this.options={...i.defaults,...t},this.state={open:!1,loading:!1,requestId:0},this._ensureBootstrap(),this._mount(),this._bindBootstrapEvents(),e(this.modalEl,"fxd:init",{modal:this}),this.options.onInit?.(this)}_ensureBootstrap(){const t=this.options.bootstrap||("undefined"!=typeof window?window.bootstrap:null);if(!t||!t.Modal)throw new Error("FxdDynamicModal requires Bootstrap 5 Modal to be available.");this.bootstrap=t}_mount(){const t=document.getElementById(this.options.modalId);if(t){if(this.modalEl=t,this.dialogEl=t.querySelector(".modal-dialog"),this.titleEl=t.querySelector('[data-fxd-role="title"]')||t.querySelector(".modal-title"),this.bodyEl=t.querySelector('[data-fxd-role="content"]')||t.querySelector(".modal-body"),this.footerEl=t.querySelector('[data-fxd-role="footer"]')||t.querySelector(".modal-footer"),this.closeBtnEl=t.querySelector('[data-fxd-role="close"]')||t.querySelector(".btn-close"),!(this.dialogEl&&this.titleEl&&this.bodyEl&&this.footerEl&&this.closeBtnEl))throw new Error("FxdDynamicModal found an existing modal but required elements are missing.")}else{const t=function(t,e){const o=document.createElement("div");o.className="modal fade",o.id=t,o.tabIndex=-1,o.setAttribute("aria-hidden","true");const s=`${t}-title`,i=`${t}-content`;o.setAttribute("aria-labelledby",s),o.setAttribute("aria-describedby",i);const l=document.createElement("div");l.className="modal-dialog modal-dialog-centered";const a=document.createElement("div");a.className="modal-content";const r=document.createElement("div");r.className="modal-header";const d=document.createElement("h5");d.className="modal-title",d.id=s,d.dataset.fxdRole="title";const c=document.createElement("button");c.type="button",c.className="btn-close",c.setAttribute("data-bs-dismiss","modal"),c.setAttribute("aria-label","Close"),c.dataset.fxdRole="close",r.appendChild(d),r.appendChild(c);const h=document.createElement("div");h.className="modal-body",h.id=i,h.dataset.fxdRole="content";const m=document.createElement("div");m.className="modal-footer",m.dataset.fxdRole="footer";const u=document.createElement("button");return u.type="button",u.className="btn btn-secondary",u.textContent=e.footerButtonText||"OK",u.setAttribute("data-bs-dismiss","modal"),m.appendChild(u),a.appendChild(r),a.appendChild(h),a.appendChild(m),l.appendChild(a),o.appendChild(l),n(h,e.loadingHtml||""),{modal:o,dialog:l,title:d,body:h,footer:m,closeBtn:c}}(this.options.modalId,this.options);document.body.appendChild(t.modal),this.modalEl=t.modal,this.dialogEl=t.dialog,this.titleEl=t.title,this.bodyEl=t.body,this.footerEl=t.footer,this.closeBtnEl=t.closeBtn}}_bindBootstrapEvents(){this._onShown=()=>{this.state.open=!0,e(this.modalEl,"fxd:open",{modal:this}),this.options.onOpen?.(this)},this._onHidden=()=>{this.state.open=!1,e(this.modalEl,"fxd:close",{modal:this}),this.options.onClose?.(this)},this.modalEl.addEventListener("shown.bs.modal",this._onShown),this.modalEl.addEventListener("hidden.bs.modal",this._onHidden)}_ensureInstance(t){const e=!!t.bgClose||"static",o=Boolean(t.bgClose);this.modalInstance&&this.bsOptions?.backdrop===e&&this.bsOptions?.keyboard===o||(this.modalInstance?.dispose(),this.modalInstance=new this.bootstrap.Modal(this.modalEl,{backdrop:e,keyboard:o}),this.bsOptions={backdrop:e,keyboard:o})}_startLoading(t){this.state.loading=!0,e(this.modalEl,"fxd:loadstart",{modal:this,source:t}),this.options.onLoadStart?.(this,t)}_endLoading(t){this.state.loading=!1,e(this.modalEl,"fxd:loadend",{modal:this,source:t}),this.options.onLoadEnd?.(this,t)}_handleError(t,o){this.state.loading=!1,e(this.modalEl,"fxd:error",{modal:this,source:o,error:t}),this.options.onError?.(t,this,o),this.options.errorHtml&&n(this.bodyEl,this.options.errorHtml,this.options.sanitize)}setTitle(t){this.titleEl.textContent=t??""}setContent(t){n(this.bodyEl,t,this.options.sanitize)}setFooter(t){this.footerEl&&n(this.footerEl,t,this.options.sanitize)}async open(t=null,e={},i={}){const l={...this.options,...i},a="string"==typeof t?t.trim():"",r=Boolean(a&&a.startsWith("#")),d=(c=t,"undefined"!=typeof Element&&(c instanceof Element||c instanceof HTMLElement));var c;const h="string"==typeof t&&!r;if(s({dialog:this.dialogEl,title:this.titleEl,footer:this.footerEl,closeBtn:this.closeBtnEl},l),h&&l.loadingHtml&&n(this.bodyEl,l.loadingHtml,l.sanitize),this._ensureInstance(l),!t)return this.modalInstance.show(),null;if(r){const e=document.querySelector(a);return e?(this._startLoading(t),n(this.bodyEl,e.innerHTML,l.sanitize),this._endLoading(t),this.modalInstance.show(),this.modalInstance.handleUpdate?.(),null):(this._handleError(new Error("Element not found"),t),this.modalInstance.show(),null)}if(d)return this._startLoading(t),n(this.bodyEl,t,l.sanitize),this._endLoading(t),this.modalInstance.show(),this.modalInstance.handleUpdate?.(),null;if(this.modalInstance.show(),h){const s=o(t,e),i=++this.state.requestId;this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this._startLoading(s);try{const t=l.fetch||fetch,e=await async function(t,e,o){const n=await e(t,{signal:o});if(!n.ok){const t=new Error(`Request failed with status ${n.status}`);throw t.status=n.status,t.response=n,t}return n.text()}(s,t,this.abortController.signal);if(i!==this.state.requestId)return null;n(this.bodyEl,e,l.sanitize),this.modalInstance.handleUpdate?.(),l.initTooltips&&(this._disposeTooltips(),this._tooltips=function(t,e={},o=null){if(!t)return;if("undefined"==typeof window)return;const n=o||window.bootstrap;if(!n||!n.Tooltip)return;return Array.from(t.querySelectorAll('[data-bs-toggle="tooltip"]')).map(t=>new n.Tooltip(t,e))}(this.bodyEl,l.tooltipOptions||{},this.bootstrap)||[]),this._endLoading(s)}catch(t){if("AbortError"===t?.name)return null;this._handleError(t,s)}return null}return this._handleError(new Error("Unsupported source type"),t),null}showConfirm(t={}){const e={...i.confirmDefaults,...t},o={...this.options,...e,showFooter:!0,footerHtml:null};this._clearConfirmState(),s({dialog:this.dialogEl,title:this.titleEl,footer:this.footerEl,closeBtn:this.closeBtnEl},o),n(this.bodyEl,e.message||"",o.sanitize),this.footerEl.innerHTML="";const l=document.createElement("button");l.type="button",l.className=`btn ${e.cancelVariant}`,l.textContent=e.cancelText,l.setAttribute("data-bs-dismiss","modal"),l.dataset.fxdRole="confirm-cancel";const a=document.createElement("button");a.type="button",a.className=`btn ${e.confirmVariant}`,a.textContent=e.confirmText,a.dataset.fxdRole="confirm-submit",this.footerEl.appendChild(l),this.footerEl.appendChild(a);let r=!1;const d=()=>{r||(r=!0,this._clearConfirmState(),e.onCancel?.({modal:this}))},c=async t=>{if(t.preventDefault(),r)return;const o=a.textContent;a.disabled=!0,l.disabled=!0,a.textContent=e.confirmLoadingText;try{e.confirmAction&&await this._executeConfirmAction(e.confirmAction),e.onConfirm?.({modal:this}),r=!0,this._clearConfirmState(),this.close()}catch(t){e.onError?.(t,{modal:this}),a.disabled=!1,l.disabled=!1,a.textContent=o}};return a.addEventListener("click",c),this.modalEl.addEventListener("hidden.bs.modal",d),this._confirmCleanup=()=>{a.removeEventListener("click",c),this.modalEl.removeEventListener("hidden.bs.modal",d),this._confirmCleanup=null},this._ensureInstance(o),this.modalInstance.show(),this}_clearConfirmState(){this._confirmCleanup?.()}async _executeConfirmAction(t){const e={method:"POST",data:{},async:!0,headers:{},...t},n=String(e.method||"POST").toUpperCase(),s={modal:this,action:e};if(!e.url)throw new Error("confirmAction.url is required.");const i=e.onBeforeSend?.(s);if(!1===i)throw new Error("confirmAction cancelled by onBeforeSend.");if(!e.async)return this._submitConfirmForm(e.url,n,e.data),null;const l=e.fetch||this.options.fetch||fetch,a="GET"===n,r={...e.headers};let d,c,h=e.url;if(a)h=o(h,e.data||{});else{const t=new URLSearchParams;Object.entries(e.data||{}).forEach(([e,o])=>{null!=o&&t.append(e,String(o))}),d=t.toString(),r["Content-Type"]||(r["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8")}let m=null;try{c=await l(h,{method:n,headers:r,body:d});const t=await c.text();try{m=JSON.parse(t)}catch{m=t}if(!c.ok)throw new Error(`confirmAction request failed with status ${c.status}.`);return e.onSuccess?.(m,c,s),m}catch(t){throw e.onError?.(t,c,s),t}finally{e.onComplete?.(s)}}_submitConfirmForm(t,e,o={}){const n=document.createElement("form");n.method=e,n.action=t,n.style.display="none",Object.entries(o).forEach(([t,e])=>{if(null==e)return;if(Array.isArray(e))return void e.forEach(e=>{if(null==e)return;const o=document.createElement("input");o.type="hidden",o.name=t,o.value=String(e),n.appendChild(o)});const o=document.createElement("input");o.type="hidden",o.name=t,o.value=String(e),n.appendChild(o)}),document.body.appendChild(n),n.submit(),n.remove()}close(){this.modalInstance?.hide()}_disposeTooltips(){this._tooltips&&0!==this._tooltips.length&&(this._tooltips.forEach(t=>t?.dispose?.()),this._tooltips=[])}destroy(){this.abortController?.abort(),this._disposeTooltips(),this.modalInstance?.dispose(),this.modalEl.removeEventListener("shown.bs.modal",this._onShown),this.modalEl.removeEventListener("hidden.bs.modal",this._onHidden),e(this.modalEl,"fxd:destroy",{modal:this}),this.options.onDestroy?.(this),this.modalEl.remove()}getState(){return{...this.state}}}i.defaults={modalId:"fxdDynamicModal",title:"Modal Title",size:"md",showFooter:!0,bgClose:!0,showCloseBtn:!0,extraModalClass:"",footerHtml:null,footerButtonText:"OK",loadingHtml:'<div class="d-flex justify-content-center align-items-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>',errorHtml:'<p class="text-danger mb-0">Error loading content</p>',sanitize:null,fetch:null,initTooltips:!0,tooltipOptions:{html:!0},bootstrap:null,onInit:null,onOpen:null,onClose:null,onLoadStart:null,onLoadEnd:null,onError:null,onDestroy:null},i.confirmDefaults={title:"Confirm Action",message:"",confirmText:"Confirm",cancelText:"Cancel",confirmVariant:"btn-danger",cancelVariant:"btn-outline-secondary",confirmLoadingText:"Working...",size:"sm",bgClose:!1,showCloseBtn:!0,onConfirm:null,onCancel:null,onError:null,confirmAction:null},t.FxdDynamicModal=i});
//# sourceMappingURL=fxd-dynamicmodal.umd.min.js.map
